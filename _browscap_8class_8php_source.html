<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Axiom: H:/Workspace/php-axiom/www/php-axiom/libraries/browser/Browscap.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="new_stylesheet.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
	<h1>Axiom (v1.2.0)</h1>
	<span>A lightweight PHP framework</span>
	        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>

</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_browscap_8class_8php.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">H:/Workspace/php-axiom/www/php-axiom/libraries/browser/Browscap.class.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_browscap_8class_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00031"></a><a class="code" href="class_browscap.html">00031</a> <span class="keyword">class </span><a class="code" href="class_browscap.html">Browscap</a>
<a name="l00032"></a>00032 {
<a name="l00036"></a><a class="code" href="class_browscap.html#a6d6cc4513815c9589ef9c3b75618721a">00036</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a6d6cc4513815c9589ef9c3b75618721a">VERSION</a>                                   = <span class="stringliteral">&#39;0.7&#39;</span>;
<a name="l00037"></a>00037 
<a name="l00046"></a><a class="code" href="class_browscap.html#a4bb06801c0ec7614991e8f27e795827d">00046</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a4bb06801c0ec7614991e8f27e795827d">UPDATE_FOPEN</a>                              = <span class="stringliteral">&#39;URL-wrapper&#39;</span>;
<a name="l00047"></a><a class="code" href="class_browscap.html#a116f54fc3b0f6572933f9275165ece98">00047</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a116f54fc3b0f6572933f9275165ece98">UPDATE_FSOCKOPEN</a>          = <span class="stringliteral">&#39;socket&#39;</span>;
<a name="l00048"></a><a class="code" href="class_browscap.html#a5ccad9a4e74911b586c59b2903f6a397">00048</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a5ccad9a4e74911b586c59b2903f6a397">UPDATE_CURL</a>                               = <span class="stringliteral">&#39;cURL&#39;</span>;
<a name="l00049"></a><a class="code" href="class_browscap.html#aa1818d249b2738caef5a427ae46e7192">00049</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#aa1818d249b2738caef5a427ae46e7192">UPDATE_LOCAL</a>                              = <span class="stringliteral">&#39;local&#39;</span>;
<a name="l00050"></a>00050 
<a name="l00057"></a><a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">00057</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">REGEX_DELIMITER</a>           = <span class="charliteral">&#39;@&#39;</span>;
<a name="l00058"></a><a class="code" href="class_browscap.html#a6865906ef9f258dc8862abc6e576b179">00058</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a6865906ef9f258dc8862abc6e576b179">REGEX_MODIFIERS</a>           = <span class="charliteral">&#39;i&#39;</span>;
<a name="l00059"></a>00059 
<a name="l00063"></a><a class="code" href="class_browscap.html#a857ddc3839444f82452a721447a0f6f7">00063</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a857ddc3839444f82452a721447a0f6f7">VALUES_TO_QUOTE</a>           = <span class="stringliteral">&#39;Browser|Parent&#39;</span>;
<a name="l00064"></a>00064 
<a name="l00072"></a><a class="code" href="class_browscap.html#a079bc86b6fd33df28eb6522a21b1c392">00072</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a079bc86b6fd33df28eb6522a21b1c392">ORDER_FUNC_ARGS</a>           = <span class="stringliteral">&#39;$a, $b&#39;</span>;
<a name="l00073"></a><a class="code" href="class_browscap.html#a72ccbb7f1ccd14121b653a4ab4efac33">00073</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a72ccbb7f1ccd14121b653a4ab4efac33">ORDER_FUNC_LOGIC</a>          = <span class="stringliteral">&#39;$a=strlen($a);$b=strlen($b);return$a==$b?0:($a&lt;$b?1:-1);&#39;</span>;
<a name="l00074"></a>00074 
<a name="l00078"></a><a class="code" href="class_browscap.html#a77453d42371ddcf8c91dec795da92bd6">00078</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a77453d42371ddcf8c91dec795da92bd6">REQUEST_HEADERS</a>           = <span class="stringliteral">&quot;GET %s HTTP/1.0\r\nHost: %s\r\nUser-Agent: %s\r\nConnection: Close\r\n\r\n&quot;</span>;
<a name="l00079"></a>00079 
<a name="l00094"></a><a class="code" href="class_browscap.html#a3cf5f39d26aa1142d29e795bd52692b3">00094</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a3cf5f39d26aa1142d29e795bd52692b3">$remoteIniUrl</a>            = <span class="stringliteral">&#39;http://browsers.garykeith.com/stream.asp?BrowsCapINI&#39;</span>;
<a name="l00095"></a><a class="code" href="class_browscap.html#abc6e4a3cd1df09dcb881dc42740364b7">00095</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#abc6e4a3cd1df09dcb881dc42740364b7">$remoteVerUrl</a>            = <span class="stringliteral">&#39;http://updates.browserproject.com/version-date.asp&#39;</span>;
<a name="l00096"></a><a class="code" href="class_browscap.html#a5cace1833759572fcefd4d0fdcb6227b">00096</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a5cace1833759572fcefd4d0fdcb6227b">$timeout</a>                                 = 5;
<a name="l00097"></a><a class="code" href="class_browscap.html#ad889e68ac21e8a0b6106d270d442f161">00097</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#ad889e68ac21e8a0b6106d270d442f161">$updateInterval</a>          = 432000; <span class="comment">// 5 days</span>
<a name="l00098"></a><a class="code" href="class_browscap.html#a362f511a508b0351d628cb26fe547858">00098</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a362f511a508b0351d628cb26fe547858">$errorInterval</a>           = 7200;           <span class="comment">// 2 hours</span>
<a name="l00099"></a><a class="code" href="class_browscap.html#ab71f1dd8358d35e9650a060d905ff11c">00099</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#ab71f1dd8358d35e9650a060d905ff11c">$doAutoUpdate</a>            = <span class="keyword">true</span>;
<a name="l00100"></a><a class="code" href="class_browscap.html#a5a07c9446a0ff9192624d219c5b86ecb">00100</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a5a07c9446a0ff9192624d219c5b86ecb">$updateMethod</a>            = null;
<a name="l00101"></a>00101 
<a name="l00108"></a><a class="code" href="class_browscap.html#adc6cc2df0b8f3fade79188962069aeca">00108</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#adc6cc2df0b8f3fade79188962069aeca">$localFile</a>                               = null;
<a name="l00109"></a>00109 
<a name="l00116"></a><a class="code" href="class_browscap.html#af72885788822104b509d92e7c4c17eb7">00116</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#af72885788822104b509d92e7c4c17eb7">$userAgent</a>                               = <span class="stringliteral">&#39;Browser Capabilities Project - PHP Browscap/%v %m&#39;</span>;
<a name="l00117"></a>00117 
<a name="l00124"></a><a class="code" href="class_browscap.html#a6b47f5a0dd13c7e9d6568dcd154dffc5">00124</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a6b47f5a0dd13c7e9d6568dcd154dffc5">$lowercase</a>                               = <span class="keyword">false</span>;
<a name="l00125"></a>00125 
<a name="l00134"></a><a class="code" href="class_browscap.html#a3e45c8f244257ce1bc20d6b83cae61b5">00134</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a3e45c8f244257ce1bc20d6b83cae61b5">$silent</a>                                  = <span class="keyword">false</span>;
<a name="l00135"></a>00135 
<a name="l00141"></a><a class="code" href="class_browscap.html#af3ab3137007f6fa0a24b542d15ed0ed2">00141</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#af3ab3137007f6fa0a24b542d15ed0ed2">$cacheFilename</a>           = <span class="stringliteral">&#39;cache.php&#39;</span>;
<a name="l00142"></a>00142 
<a name="l00148"></a><a class="code" href="class_browscap.html#ad06085c6441edc519abfaa5a9927622a">00148</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#ad06085c6441edc519abfaa5a9927622a">$iniFilename</a>                             = <span class="stringliteral">&#39;browscap.ini&#39;</span>;
<a name="l00149"></a>00149 
<a name="l00155"></a><a class="code" href="class_browscap.html#a1be776a7b96d8c01a6bf45ce20a8f59a">00155</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a1be776a7b96d8c01a6bf45ce20a8f59a">$cacheDir</a>                                = null;
<a name="l00156"></a>00156 
<a name="l00162"></a><a class="code" href="class_browscap.html#abf6d24dd7988f82e8573305994bcfd3e">00162</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#abf6d24dd7988f82e8573305994bcfd3e">$_cacheLoaded</a>           = <span class="keyword">false</span>;
<a name="l00163"></a>00163 
<a name="l00169"></a><a class="code" href="class_browscap.html#afc001998d0530df9f8fbd2a807768c31">00169</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#afc001998d0530df9f8fbd2a807768c31">$_userAgents</a>            = array();
<a name="l00170"></a><a class="code" href="class_browscap.html#ac3b2e2a065585665ccf59d4241c076e2">00170</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#ac3b2e2a065585665ccf59d4241c076e2">$_browsers</a>                              = array();
<a name="l00171"></a><a class="code" href="class_browscap.html#a75cee4529db44cfe300c96c76840afc3">00171</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#a75cee4529db44cfe300c96c76840afc3">$_patterns</a>                              = array();
<a name="l00172"></a><a class="code" href="class_browscap.html#a7685974adf550455a5cfe604ba0e16bf">00172</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#a7685974adf550455a5cfe604ba0e16bf">$_properties</a>            = array();
<a name="l00173"></a>00173 
<a name="l00180"></a><a class="code" href="class_browscap.html#a3811d4c7cf568446f8cdf6b407e12d71">00180</a>                 <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a3811d4c7cf568446f8cdf6b407e12d71">__construct</a>($cache_dir)
<a name="l00181"></a>00181                 {
<a name="l00182"></a>00182                                 <span class="comment">// has to be set to reach E_STRICT compatibility, does not affect system/app settings</span>
<a name="l00183"></a>00183                                 date_default_timezone_set(date_default_timezone_get());
<a name="l00184"></a>00184 
<a name="l00185"></a>00185                                 <span class="keywordflow">if</span> (!isset($cache_dir)) {
<a name="l00186"></a>00186                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;You have to provide a path to read/store the browscap cache file&quot;</span>, 2034);
<a name="l00187"></a>00187                                 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189                                 $cache_dir = realpath($cache_dir);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191                                 <span class="comment">// Is the cache dir really the directory or is it directly the file?</span>
<a name="l00192"></a>00192                                 <span class="keywordflow">if</span> (substr($cache_dir, -4) === <span class="stringliteral">&#39;.php&#39;</span>) {
<a name="l00193"></a>00193                                                 $this-&gt;cacheFilename = basename($cache_dir);
<a name="l00194"></a>00194                                                 $this-&gt;cacheDir = dirname($cache_dir);
<a name="l00195"></a>00195                                 } <span class="keywordflow">else</span> {
<a name="l00196"></a>00196                                                 $this-&gt;cacheDir = $cache_dir;
<a name="l00197"></a>00197                                 }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                                 $this-&gt;cacheDir .= DIRECTORY_SEPARATOR;
<a name="l00200"></a>00200                 }
<a name="l00201"></a>00201 
<a name="l00211"></a><a class="code" href="class_browscap.html#aeac9cab5428d846a64100b9768f2ce3d">00211</a>                 <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#aeac9cab5428d846a64100b9768f2ce3d">getBrowser</a>($user_agent = null, $return_array = <span class="keyword">false</span>)
<a name="l00212"></a>00212                 {
<a name="l00213"></a>00213                                 <span class="comment">// Load the cache at the first request</span>
<a name="l00214"></a>00214                                 <span class="keywordflow">if</span> (!$this-&gt;_cacheLoaded) {
<a name="l00215"></a>00215                                                 $cache_file = $this-&gt;cacheDir . $this-&gt;cacheFilename;
<a name="l00216"></a>00216                                                 $ini_file       = $this-&gt;cacheDir . $this-&gt;iniFilename;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218                                                 <span class="comment">// Set the interval only if needed</span>
<a name="l00219"></a>00219                                                 <span class="keywordflow">if</span> ($this-&gt;doAutoUpdate &amp;&amp; file_exists($ini_file)) {
<a name="l00220"></a>00220                                                                 $interval = time() - filemtime($ini_file);
<a name="l00221"></a>00221                                                 } <span class="keywordflow">else</span> {
<a name="l00222"></a>00222                                                                 $interval = 0;
<a name="l00223"></a>00223                                                 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225                                                 <span class="comment">// Find out if the cache needs to be updated</span>
<a name="l00226"></a>00226                                                 <span class="keywordflow">if</span> (!file_exists($cache_file) || !file_exists($ini_file) || ($interval &gt; $this-&gt;updateInterval)) {
<a name="l00227"></a>00227                                                                 <span class="keywordflow">try</span> {
<a name="l00228"></a>00228                                                                                 $this-&gt;<a class="code" href="class_browscap.html#acc4b8a4876aa93bd8e94add85e112a04">updateCache</a>();
<a name="l00229"></a>00229                                                                 } <span class="keywordflow">catch</span> (RuntimeException $e) {
<a name="l00230"></a>00230                                                                                 <span class="keywordflow">if</span> (file_exists($ini_file)) {
<a name="l00231"></a>00231                                                                                                 <span class="comment">// Adjust the filemtime to the $errorInterval</span>
<a name="l00232"></a>00232                                                                                                 touch($ini_file, time() - $this-&gt;updateInterval + $this-&gt;errorInterval);
<a name="l00233"></a>00233                                                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;silent) {
<a name="l00234"></a>00234                                                                                                 <span class="comment">// Return an array if silent mode is active and the ini db doesn&#39;t exsist</span>
<a name="l00235"></a>00235                                                                                                 <span class="keywordflow">return</span> array();
<a name="l00236"></a>00236                                                                                 }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238                                                                                 <span class="keywordflow">if</span> (!$this-&gt;silent) {
<a name="l00239"></a>00239                                                                                     <span class="keywordflow">if</span> (PHP_VERSION_ID &gt;= 50300)
<a name="l00240"></a>00240                                                                                                     <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Update cache failed&quot;</span>, 2035, $e);
<a name="l00241"></a>00241                                                                         <span class="keywordflow">else</span>
<a name="l00242"></a>00242                                                                             <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Update cache failed&quot;</span>, 2035);
<a name="l00243"></a>00243                                                                                 }
<a name="l00244"></a>00244                                                                 }
<a name="l00245"></a>00245                                                 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247                                                 $this-&gt;<a class="code" href="class_browscap.html#abf1cd07f603daa567f53228744f75bad">_loadCache</a>($cache_file);
<a name="l00248"></a>00248                                 }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250                                 <span class="comment">// Automatically detect the useragent</span>
<a name="l00251"></a>00251                                 <span class="keywordflow">if</span> (!isset($user_agent)) {
<a name="l00252"></a>00252                                                 <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>])) {
<a name="l00253"></a>00253                                                                 $user_agent = $_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>];
<a name="l00254"></a>00254                                                 } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255                                                                 $user_agent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00256"></a>00256                                                 }
<a name="l00257"></a>00257                                 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259                                 $browser = array();
<a name="l00260"></a>00260                                 <span class="keywordflow">foreach</span> ($this-&gt;_patterns as $key =&gt; $pattern) {
<a name="l00261"></a>00261                                                 <span class="keywordflow">if</span> (preg_match($pattern . <span class="charliteral">&#39;i&#39;</span>, $user_agent)) {
<a name="l00262"></a>00262                                                                 $browser = array(
<a name="l00263"></a>00263                                                                                 $user_agent, <span class="comment">// Original useragent</span>
<a name="l00264"></a>00264                                                                                 trim(strtolower($pattern), self::REGEX_DELIMITER),
<a name="l00265"></a>00265                                                                                 $this-&gt;_userAgents[$key]
<a name="l00266"></a>00266                                                                 );
<a name="l00267"></a>00267 
<a name="l00268"></a>00268                                                                 $browser = $value = $browser + $this-&gt;_browsers[$key];
<a name="l00269"></a>00269 
<a name="l00270"></a>00270                                                                 <span class="keywordflow">while</span> (array_key_exists(3, $value) &amp;&amp; $value[3]) {
<a name="l00271"></a>00271                                                                                 $value                          =               $this-&gt;_browsers[$value[3]];
<a name="l00272"></a>00272                                                                                 $browser        +=              $value;
<a name="l00273"></a>00273                                                                 }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275                                                                 <span class="keywordflow">if</span> (!empty($browser[3])) {
<a name="l00276"></a>00276                                                                                 $browser[3] = $this-&gt;_userAgents[$browser[3]];
<a name="l00277"></a>00277                                                                 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279                                                                 <span class="keywordflow">break</span>;
<a name="l00280"></a>00280                                                 }
<a name="l00281"></a>00281                                 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283                                 <span class="comment">// Add the keys for each property</span>
<a name="l00284"></a>00284                                 $array = array();
<a name="l00285"></a>00285                                 <span class="keywordflow">foreach</span> ($browser as $key =&gt; $value) {
<a name="l00286"></a>00286       <span class="keywordflow">if</span> ($value === <span class="stringliteral">&#39;true&#39;</span>) {
<a name="l00287"></a>00287         $value = <span class="keyword">true</span>;
<a name="l00288"></a>00288       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($value === <span class="stringliteral">&#39;false&#39;</span>) {
<a name="l00289"></a>00289         $value = <span class="keyword">false</span>;
<a name="l00290"></a>00290       }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292                                                 $array[$this-&gt;_properties[$key]] = $value;
<a name="l00293"></a>00293                                 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295                                 <span class="keywordflow">return</span> $return_array ? $array : (object) $array;
<a name="l00296"></a>00296                 }
<a name="l00297"></a>00297 
<a name="l00303"></a><a class="code" href="class_browscap.html#acc4b8a4876aa93bd8e94add85e112a04">00303</a>                 <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#acc4b8a4876aa93bd8e94add85e112a04">updateCache</a>()
<a name="l00304"></a>00304                 {
<a name="l00305"></a>00305                                 $ini_path                                       = $this-&gt;cacheDir . $this-&gt;iniFilename;
<a name="l00306"></a>00306                                 $cache_path                                     = $this-&gt;cacheDir . $this-&gt;cacheFilename;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308                                 <span class="comment">// Choose the right url</span>
<a name="l00309"></a>00309                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>() == self::UPDATE_LOCAL) {
<a name="l00310"></a>00310                                                 $url = $this-&gt;localFile;
<a name="l00311"></a>00311                                 } <span class="keywordflow">else</span> {
<a name="l00312"></a>00312                                                 $url = $this-&gt;remoteIniUrl;
<a name="l00313"></a>00313                                 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315                                 $this-&gt;<a class="code" href="class_browscap.html#a7f6b082f1c3b4dfd5ab839b057fc67d7">_getRemoteIniFile</a>($url, $ini_path);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317                                 <span class="keywordflow">if</span> (version_compare(PHP_VERSION, <span class="stringliteral">&#39;5.3.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>)){
<a name="l00318"></a>00318                                                 $browsers = parse_ini_file($ini_path, <span class="keyword">true</span>, INI_SCANNER_RAW);
<a name="l00319"></a>00319                                 } <span class="keywordflow">else</span> {
<a name="l00320"></a>00320                                                 $browsers = parse_ini_file($ini_path, <span class="keyword">true</span>);
<a name="l00321"></a>00321                                 }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                                 array_shift($browsers);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                                 $this-&gt;_properties              = array_keys($browsers[<span class="stringliteral">&#39;DefaultProperties&#39;</span>]);
<a name="l00326"></a>00326                                 array_unshift(
<a name="l00327"></a>00327                                                 $this-&gt;_properties,
<a name="l00328"></a>00328                                                 <span class="stringliteral">&#39;browser_name&#39;</span>,
<a name="l00329"></a>00329                                                 <span class="stringliteral">&#39;browser_name_regex&#39;</span>,
<a name="l00330"></a>00330                                                 <span class="stringliteral">&#39;browser_name_pattern&#39;</span>,
<a name="l00331"></a>00331                                                 <span class="stringliteral">&#39;Parent&#39;</span>
<a name="l00332"></a>00332                                 );
<a name="l00333"></a>00333 
<a name="l00334"></a>00334                                 $this-&gt;_userAgents              = array_keys($browsers);
<a name="l00335"></a>00335                                 usort(
<a name="l00336"></a>00336                                                 $this-&gt;_userAgents,
<a name="l00337"></a>00337                                                 create_function(self::ORDER_FUNC_ARGS, self::ORDER_FUNC_LOGIC)
<a name="l00338"></a>00338                                 );
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                                 $user_agents_keys               = array_flip($this-&gt;_userAgents);
<a name="l00341"></a>00341                                 $properties_keys                = array_flip($this-&gt;_properties);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343                                 $search                                                         = array(<span class="charliteral">&#39;\*&#39;</span>, <span class="charliteral">&#39;\?&#39;</span>);
<a name="l00344"></a>00344                                 $replace                                        = array(<span class="stringliteral">&#39;.*&#39;</span>, <span class="charliteral">&#39;.&#39;</span>);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346                                 <span class="keywordflow">foreach</span> ($this-&gt;_userAgents as $user_agent) {
<a name="l00347"></a>00347                                                 $pattern = preg_quote($user_agent, self::REGEX_DELIMITER);
<a name="l00348"></a>00348                                                 $this-&gt;_patterns[]              = self::REGEX_DELIMITER
<a name="l00349"></a>00349                                                                                                                                 . <span class="charliteral">&#39;^&#39;</span>
<a name="l00350"></a>00350                                                                                                                                 . str_replace($search, $replace, $pattern)
<a name="l00351"></a>00351                                                                                                                                 . <span class="charliteral">&#39;$&#39;</span>
<a name="l00352"></a>00352                                                                                                                                 . <a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">self::REGEX_DELIMITER</a>;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                                                 <span class="keywordflow">if</span> (!empty($browsers[$user_agent][<span class="stringliteral">&#39;Parent&#39;</span>])) {
<a name="l00355"></a>00355                                                                 $parent = $browsers[$user_agent][<span class="stringliteral">&#39;Parent&#39;</span>];
<a name="l00356"></a>00356                                                                 $browsers[$user_agent][<span class="stringliteral">&#39;Parent&#39;</span>] = $user_agents_keys[$parent];
<a name="l00357"></a>00357                                                 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359                                                 <span class="keywordflow">foreach</span> ($browsers[$user_agent] as $key =&gt; $value) {
<a name="l00360"></a>00360                                                                 $key = $properties_keys[$key] . <span class="stringliteral">&quot;.0&quot;</span>;
<a name="l00361"></a>00361                                                                 $browser[$key] = $value;
<a name="l00362"></a>00362                                                 }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364                                                 $this-&gt;_browsers[] = $browser;
<a name="l00365"></a>00365                                                 unset($browser);
<a name="l00366"></a>00366                                 }
<a name="l00367"></a>00367                                 unset($user_agents_keys, $properties_keys, $browsers);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                                 <span class="comment">// Save the keys lowercased if needed</span>
<a name="l00370"></a>00370                                 <span class="keywordflow">if</span> ($this-&gt;lowercase) {
<a name="l00371"></a>00371                                                 $this-&gt;_properties = array_map(<span class="stringliteral">&#39;strtolower&#39;</span>, $this-&gt;_properties);
<a name="l00372"></a>00372                                 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374                                 <span class="comment">// Get the whole PHP code</span>
<a name="l00375"></a>00375                                 $cache = $this-&gt;<a class="code" href="class_browscap.html#a33a0ff1a7b7574296837bdae9c538d27">_buildCache</a>();
<a name="l00376"></a>00376 
<a name="l00377"></a>00377                                 <span class="comment">// Save and return</span>
<a name="l00378"></a>00378                                 <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>) file_put_contents($cache_path, $cache, LOCK_EX);
<a name="l00379"></a>00379                 }
<a name="l00380"></a>00380 
<a name="l00386"></a><a class="code" href="class_browscap.html#abf1cd07f603daa567f53228744f75bad">00386</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#abf1cd07f603daa567f53228744f75bad">_loadCache</a>($cache_file)
<a name="l00387"></a>00387                 {
<a name="l00388"></a>00388                                 require $cache_file;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390                                 $this-&gt;_browsers                = $browsers;
<a name="l00391"></a>00391                                 $this-&gt;_userAgents              = $userAgents;
<a name="l00392"></a>00392                                 $this-&gt;_patterns                = $patterns;
<a name="l00393"></a>00393                                 $this-&gt;_properties              = $properties;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                                 $this-&gt;_cacheLoaded = <span class="keyword">true</span>;
<a name="l00396"></a>00396                 }
<a name="l00397"></a>00397 
<a name="l00403"></a><a class="code" href="class_browscap.html#a33a0ff1a7b7574296837bdae9c538d27">00403</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a33a0ff1a7b7574296837bdae9c538d27">_buildCache</a>()
<a name="l00404"></a>00404                 {
<a name="l00405"></a>00405                                 $cacheTpl = <span class="stringliteral">&quot;&lt;?php\n\$properties=%s;\n\$browsers=%s;\n\$userAgents=%s;\n\$patterns=%s;\n&quot;</span>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407                                 $propertiesArray                = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_properties);
<a name="l00408"></a>00408                                 $patternsArray                  = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_patterns);
<a name="l00409"></a>00409                                 $userAgentsArray                = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_userAgents);
<a name="l00410"></a>00410                                 $browsersArray                  = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_browsers);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412                                 <span class="keywordflow">return</span> sprintf(
<a name="l00413"></a>00413                                                 $cacheTpl,
<a name="l00414"></a>00414                                                 $propertiesArray,
<a name="l00415"></a>00415                                                 $browsersArray,
<a name="l00416"></a>00416                                                 $userAgentsArray,
<a name="l00417"></a>00417                                                 $patternsArray
<a name="l00418"></a>00418                                 );
<a name="l00419"></a>00419                 }
<a name="l00420"></a>00420 
<a name="l00430"></a><a class="code" href="class_browscap.html#a7f6b082f1c3b4dfd5ab839b057fc67d7">00430</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a7f6b082f1c3b4dfd5ab839b057fc67d7">_getRemoteIniFile</a>($url, $path)
<a name="l00431"></a>00431                 {
<a name="l00432"></a>00432                                 <span class="comment">// Check version</span>
<a name="l00433"></a>00433                                 <span class="keywordflow">if</span> (file_exists($path) &amp;&amp; filesize($path)) {
<a name="l00434"></a>00434                                                 $local_tmstp    = filemtime($path);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436                                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>() == self::UPDATE_LOCAL) {
<a name="l00437"></a>00437                                                                 $remote_tmstp = $this-&gt;<a class="code" href="class_browscap.html#ae2b8c55e462e837907483240c4f785fe">_getLocalMTime</a>();
<a name="l00438"></a>00438                                                 } <span class="keywordflow">else</span> {
<a name="l00439"></a>00439                                                                 $remote_tmstp = $this-&gt;<a class="code" href="class_browscap.html#ad362b45734467dab2fecb3f0d56a1589">_getRemoteMTime</a>();
<a name="l00440"></a>00440                                                 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                                                 <span class="keywordflow">if</span> ($remote_tmstp &lt; $local_tmstp) {
<a name="l00443"></a>00443                                                                 <span class="comment">// No update needed, return</span>
<a name="l00444"></a>00444                                                                 touch($path);
<a name="l00445"></a>00445                                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00446"></a>00446                                                 }
<a name="l00447"></a>00447                                 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                                 <span class="comment">// Get updated .ini file</span>
<a name="l00450"></a>00450                                 $browscap = $this-&gt;<a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">_getRemoteData</a>($url);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                                 $browscap = explode(<span class="stringliteral">&quot;\n&quot;</span>, $browscap);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                                 $pattern = self::REGEX_DELIMITER
<a name="l00456"></a>00456                                                                  . <span class="charliteral">&#39;(&#39;</span>
<a name="l00457"></a>00457                                                                  . self::VALUES_TO_QUOTE
<a name="l00458"></a>00458                                                                  . <span class="stringliteral">&#39;)=&quot;?([^&quot;]*)&quot;?$&#39;</span>
<a name="l00459"></a>00459                                                                  . <a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">self::REGEX_DELIMITER</a>;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 
<a name="l00462"></a>00462                                 <span class="comment">// Ok, lets read the file</span>
<a name="l00463"></a>00463                                 $content = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00464"></a>00464                                 <span class="keywordflow">foreach</span> ($browscap as $subject) {
<a name="l00465"></a>00465                                                 $subject = trim($subject);
<a name="l00466"></a>00466                                                 $content .= preg_replace($pattern, <span class="stringliteral">&#39;$1=&quot;$2&quot;&#39;</span>, $subject) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00467"></a>00467                                 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469                                 <span class="keywordflow">if</span> (!file_put_contents($path, $content)) {
<a name="l00470"></a>00470                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Could not write .ini content to $path&quot;</span>, 2036);
<a name="l00471"></a>00471                                 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00474"></a>00474                 }
<a name="l00475"></a>00475 
<a name="l00482"></a><a class="code" href="class_browscap.html#ad362b45734467dab2fecb3f0d56a1589">00482</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#ad362b45734467dab2fecb3f0d56a1589">_getRemoteMTime</a>()
<a name="l00483"></a>00483                 {
<a name="l00484"></a>00484                                 $remote_datetime = $this-&gt;<a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">_getRemoteData</a>($this-&gt;remoteVerUrl);
<a name="l00485"></a>00485                                 $remote_tmstp = strtotime($remote_datetime);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487                                 <span class="keywordflow">if</span> (!$remote_tmstp) {
<a name="l00488"></a>00488                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Bad datetime format from {$this-&gt;remoteVerUrl}&quot;</span>, 2037);
<a name="l00489"></a>00489                                 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491                                 <span class="keywordflow">return</span> $remote_tmstp;
<a name="l00492"></a>00492                 }
<a name="l00493"></a>00493 
<a name="l00500"></a><a class="code" href="class_browscap.html#ae2b8c55e462e837907483240c4f785fe">00500</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#ae2b8c55e462e837907483240c4f785fe">_getLocalMTime</a>()
<a name="l00501"></a>00501                 {
<a name="l00502"></a>00502                                 <span class="keywordflow">if</span> (!is_readable($this-&gt;localFile) || !is_file($this-&gt;localFile)) {
<a name="l00503"></a>00503                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Local file is not readable&quot;</span>, 2038);
<a name="l00504"></a>00504                                 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506                                 <span class="keywordflow">return</span> filemtime($this-&gt;localFile);
<a name="l00507"></a>00507                 }
<a name="l00508"></a>00508 
<a name="l00518"></a><a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">00518</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($array)
<a name="l00519"></a>00519                 {
<a name="l00520"></a>00520                                 $strings = array();
<a name="l00521"></a>00521 
<a name="l00522"></a>00522                                 <span class="keywordflow">foreach</span> ($array as $key =&gt; $value) {
<a name="l00523"></a>00523                                                 <span class="keywordflow">if</span> (is_int($key)) {
<a name="l00524"></a>00524                                                                 $key            = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00525"></a>00525                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctype_digit((<span class="keywordtype">string</span>) $key) || strpos($key, <span class="stringliteral">&#39;.0&#39;</span>)) {
<a name="l00526"></a>00526                                                                 $key            = intval($key) . <span class="stringliteral">&#39;=&gt;&#39;</span> ;
<a name="l00527"></a>00527                                                 } <span class="keywordflow">else</span> {
<a name="l00528"></a>00528                                                                 $key            = <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;\&#39;&quot;</span>, $key) . <span class="stringliteral">&quot;&#39;=&gt;&quot;</span> ;
<a name="l00529"></a>00529                                                 }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531                                                 <span class="keywordflow">if</span> (is_array($value)) {
<a name="l00532"></a>00532                                                                 $value          = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($value);
<a name="l00533"></a>00533                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctype_digit((<span class="keywordtype">string</span>) $value)) {
<a name="l00534"></a>00534                                                                 $value          = intval($value);
<a name="l00535"></a>00535                                                 } <span class="keywordflow">else</span> {
<a name="l00536"></a>00536                                                                 $value          = <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;\&#39;&quot;</span>, $value) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00537"></a>00537                                                 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                                                 $strings[]      = $key . $value;
<a name="l00540"></a>00540                                 }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542                                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;array(&#39;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, $strings) . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00543"></a>00543                 }
<a name="l00544"></a>00544 
<a name="l00551"></a><a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">00551</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>()
<a name="l00552"></a>00552                 {
<a name="l00553"></a>00553                                 <span class="comment">// Caches the result</span>
<a name="l00554"></a>00554                                 <span class="keywordflow">if</span> ($this-&gt;updateMethod === null) {
<a name="l00555"></a>00555                                                 <span class="keywordflow">if</span> ($this-&gt;localFile !== null) {
<a name="l00556"></a>00556                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#aa1818d249b2738caef5a427ae46e7192">self::UPDATE_LOCAL</a>;
<a name="l00557"></a>00557                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;allow_url_fopen&#39;</span>) &amp;&amp; function_exists(<span class="stringliteral">&#39;file_get_contents&#39;</span>)) {
<a name="l00558"></a>00558                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#a4bb06801c0ec7614991e8f27e795827d">self::UPDATE_FOPEN</a>;
<a name="l00559"></a>00559                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;fsockopen&#39;</span>)) {
<a name="l00560"></a>00560                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#a116f54fc3b0f6572933f9275165ece98">self::UPDATE_FSOCKOPEN</a>;
<a name="l00561"></a>00561                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (extension_loaded(<span class="stringliteral">&#39;curl&#39;</span>)) {
<a name="l00562"></a>00562                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#a5ccad9a4e74911b586c59b2903f6a397">self::UPDATE_CURL</a>;
<a name="l00563"></a>00563                                                 } <span class="keywordflow">else</span> {
<a name="l00564"></a>00564                                                                 $this-&gt;updateMethod = <span class="keyword">false</span>;
<a name="l00565"></a>00565                                                 }
<a name="l00566"></a>00566                                 }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568                                 <span class="keywordflow">return</span> $this-&gt;updateMethod;
<a name="l00569"></a>00569                 }
<a name="l00570"></a>00570 
<a name="l00578"></a><a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">00578</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">_getRemoteData</a>($url)
<a name="l00579"></a>00579                 {
<a name="l00580"></a>00580                                 ini_set(<span class="stringliteral">&#39;user_agent&#39;</span>, $this-&gt;<a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>());
<a name="l00581"></a>00581                                 
<a name="l00582"></a>00582                                 <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>()) {
<a name="l00583"></a>00583                                                 <span class="keywordflow">case</span> self::UPDATE_LOCAL:
<a name="l00584"></a>00584                                                                 $file = file_get_contents($url);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586                                                                 <span class="keywordflow">if</span> ($file !== <span class="keyword">false</span>) {
<a name="l00587"></a>00587                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00588"></a>00588                                                                 } <span class="keywordflow">else</span> {
<a name="l00589"></a>00589                                                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&#39;Cannot open the local file&#39;</span>, 2039);
<a name="l00590"></a>00590                                                                 }
<a name="l00591"></a>00591                                                 <span class="keywordflow">case</span> self::UPDATE_FOPEN:
<a name="l00592"></a>00592                                                                 $file = file_get_contents($url);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594                                                                 <span class="keywordflow">if</span> ($file !== <span class="keyword">false</span>) {
<a name="l00595"></a>00595                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00596"></a>00596                                                                 } <span class="comment">// else try with the next possibility (break omitted)</span>
<a name="l00597"></a>00597                                                 <span class="keywordflow">case</span> self::UPDATE_FSOCKOPEN:
<a name="l00598"></a>00598                                                                 $remote_url                     = parse_url($url);
<a name="l00599"></a>00599                                                                 $remote_handler = fsockopen($remote_url[<span class="stringliteral">&#39;host&#39;</span>], 80, $c, $e, $this-&gt;timeout);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601                                                                 <span class="keywordflow">if</span> ($remote_handler) {
<a name="l00602"></a>00602                                                                                 stream_set_timeout($remote_handler, $this-&gt;timeout);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604                                                                                 <span class="keywordflow">if</span> (isset($remote_url[<span class="stringliteral">&#39;query&#39;</span>])) {
<a name="l00605"></a>00605                                                                                                 $remote_url[<span class="stringliteral">&#39;path&#39;</span>] .= <span class="charliteral">&#39;?&#39;</span> . $remote_url[<span class="stringliteral">&#39;query&#39;</span>];
<a name="l00606"></a>00606                                                                                 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608                                                                                 $out = sprintf(
<a name="l00609"></a>00609                                                                                                 self::REQUEST_HEADERS,
<a name="l00610"></a>00610                                                                                                 $remote_url[<span class="stringliteral">&#39;path&#39;</span>],
<a name="l00611"></a>00611                                                                                                 $remote_url[<span class="stringliteral">&#39;host&#39;</span>],
<a name="l00612"></a>00612                                                                                                 $this-&gt;<a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>()
<a name="l00613"></a>00613                                                                                 );
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                                                                                 fwrite($remote_handler, $out);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617                                                                                 $response = fgets($remote_handler);
<a name="l00618"></a>00618                                                                                 <span class="keywordflow">if</span> (strpos($response, <span class="stringliteral">&#39;200 OK&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l00619"></a>00619                                                                                                 $file = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00620"></a>00620                                                                                                 <span class="keywordflow">while</span> (!feof($remote_handler)) {
<a name="l00621"></a>00621                                                                                                                 $file .= fgets($remote_handler);
<a name="l00622"></a>00622                                                                                                 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624                                                                                                 $file = str_replace(<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $file);
<a name="l00625"></a>00625                                                                                                 $file = explode(<span class="stringliteral">&quot;\n\n&quot;</span>, $file);
<a name="l00626"></a>00626                                                                                                 array_shift($file);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628                                                                                                 $file = implode(<span class="stringliteral">&quot;\n\n&quot;</span>, $file);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630                                                                                                 fclose($remote_handler);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632                                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00633"></a>00633                                                                                 }
<a name="l00634"></a>00634                                                                 } <span class="comment">// else try with the next possibility</span>
<a name="l00635"></a>00635                                                 <span class="keywordflow">case</span> self::UPDATE_CURL:
<a name="l00636"></a>00636                                                                 $ch = curl_init($url);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638                                                                 curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);
<a name="l00639"></a>00639                                                                 curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $this-&gt;timeout);
<a name="l00640"></a>00640                                                                 curl_setopt($ch, CURLOPT_USERAGENT, $this-&gt;<a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>());
<a name="l00641"></a>00641 
<a name="l00642"></a>00642                                                                 $file = curl_exec($ch);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644                                                                 curl_close($ch);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                                                                 <span class="keywordflow">if</span> ($file !== <span class="keyword">false</span>) {
<a name="l00647"></a>00647                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00648"></a>00648                                                                 } <span class="comment">// else try with the next possibility</span>
<a name="l00649"></a>00649                                                 <span class="keywordflow">case</span> <span class="keyword">false</span>:
<a name="l00650"></a>00650                                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Your server can&#39;t connect to external resources. Please update the file manually.&quot;</span>, 2033);
<a name="l00651"></a>00651                                 }
<a name="l00652"></a>00652                 }
<a name="l00653"></a>00653 
<a name="l00660"></a><a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">00660</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>()
<a name="l00661"></a>00661                 {
<a name="l00662"></a>00662                                 $ua = str_replace(<span class="stringliteral">&#39;%v&#39;</span>, self::VERSION, $this-&gt;userAgent);
<a name="l00663"></a>00663                                 $ua = str_replace(<span class="stringliteral">&#39;%m&#39;</span>, $this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>(), $ua);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665                                 <span class="keywordflow">return</span> $ua;
<a name="l00666"></a>00666                 }
<a name="l00667"></a>00667 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_browscap_8class_8php.html">Browscap.class.php</a>      </li>

    <li class="footer">Generated on Tue Feb 21 2012 18:14:03 for Axiom by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
