<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Axiom: H:/Workspace/php-axiom/www/php-axiom/libraries/browser/Browscap.class.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="new_stylesheet.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
	<h1>Axiom (v1.2.0)</h1>
	<span>A lightweight PHP framework</span>
	        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>

</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_browscap_8class_8php.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">H:/Workspace/php-axiom/www/php-axiom/libraries/browser/Browscap.class.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_browscap_8class_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00014"></a><a class="code" href="class_browscap.html">00014</a> <span class="keyword">class </span><a class="code" href="class_browscap.html" title="Browscap.ini parsing class with caching and update capabilities.">Browscap</a>
<a name="l00015"></a>00015 {
<a name="l00019"></a><a class="code" href="class_browscap.html#a6d6cc4513815c9589ef9c3b75618721a">00019</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a6d6cc4513815c9589ef9c3b75618721a">VERSION</a>                                   = <span class="stringliteral">&#39;0.7&#39;</span>;
<a name="l00020"></a>00020 
<a name="l00029"></a><a class="code" href="class_browscap.html#a4bb06801c0ec7614991e8f27e795827d">00029</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a4bb06801c0ec7614991e8f27e795827d">UPDATE_FOPEN</a>                              = <span class="stringliteral">&#39;URL-wrapper&#39;</span>;
<a name="l00030"></a><a class="code" href="class_browscap.html#a116f54fc3b0f6572933f9275165ece98">00030</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a116f54fc3b0f6572933f9275165ece98">UPDATE_FSOCKOPEN</a>          = <span class="stringliteral">&#39;socket&#39;</span>;
<a name="l00031"></a><a class="code" href="class_browscap.html#a5ccad9a4e74911b586c59b2903f6a397">00031</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a5ccad9a4e74911b586c59b2903f6a397">UPDATE_CURL</a>                               = <span class="stringliteral">&#39;cURL&#39;</span>;
<a name="l00032"></a><a class="code" href="class_browscap.html#aa1818d249b2738caef5a427ae46e7192">00032</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#aa1818d249b2738caef5a427ae46e7192">UPDATE_LOCAL</a>                              = <span class="stringliteral">&#39;local&#39;</span>;
<a name="l00033"></a>00033 
<a name="l00040"></a><a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">00040</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">REGEX_DELIMITER</a>           = <span class="charliteral">&#39;@&#39;</span>;
<a name="l00041"></a><a class="code" href="class_browscap.html#a6865906ef9f258dc8862abc6e576b179">00041</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a6865906ef9f258dc8862abc6e576b179">REGEX_MODIFIERS</a>           = <span class="charliteral">&#39;i&#39;</span>;
<a name="l00042"></a>00042 
<a name="l00046"></a><a class="code" href="class_browscap.html#a857ddc3839444f82452a721447a0f6f7">00046</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a857ddc3839444f82452a721447a0f6f7">VALUES_TO_QUOTE</a>           = <span class="stringliteral">&#39;Browser|Parent&#39;</span>;
<a name="l00047"></a>00047 
<a name="l00055"></a><a class="code" href="class_browscap.html#a079bc86b6fd33df28eb6522a21b1c392">00055</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a079bc86b6fd33df28eb6522a21b1c392">ORDER_FUNC_ARGS</a>           = <span class="stringliteral">&#39;$a, $b&#39;</span>;
<a name="l00056"></a><a class="code" href="class_browscap.html#a72ccbb7f1ccd14121b653a4ab4efac33">00056</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a72ccbb7f1ccd14121b653a4ab4efac33">ORDER_FUNC_LOGIC</a>          = <span class="stringliteral">&#39;$a=strlen($a);$b=strlen($b);return$a==$b?0:($a&lt;$b?1:-1);&#39;</span>;
<a name="l00057"></a>00057 
<a name="l00061"></a><a class="code" href="class_browscap.html#a77453d42371ddcf8c91dec795da92bd6">00061</a>                 <span class="keyword">const</span> <a class="code" href="class_browscap.html#a77453d42371ddcf8c91dec795da92bd6">REQUEST_HEADERS</a>           = <span class="stringliteral">&quot;GET %s HTTP/1.0\r\nHost: %s\r\nUser-Agent: %s\r\nConnection: Close\r\n\r\n&quot;</span>;
<a name="l00062"></a>00062 
<a name="l00077"></a><a class="code" href="class_browscap.html#a3cf5f39d26aa1142d29e795bd52692b3">00077</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a3cf5f39d26aa1142d29e795bd52692b3">$remoteIniUrl</a>            = <span class="stringliteral">&#39;http://browsers.garykeith.com/stream.asp?BrowsCapINI&#39;</span>;
<a name="l00078"></a><a class="code" href="class_browscap.html#abc6e4a3cd1df09dcb881dc42740364b7">00078</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#abc6e4a3cd1df09dcb881dc42740364b7">$remoteVerUrl</a>            = <span class="stringliteral">&#39;http://updates.browserproject.com/version-date.asp&#39;</span>;
<a name="l00079"></a><a class="code" href="class_browscap.html#a5cace1833759572fcefd4d0fdcb6227b">00079</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a5cace1833759572fcefd4d0fdcb6227b">$timeout</a>                                 = 5;
<a name="l00080"></a><a class="code" href="class_browscap.html#ad889e68ac21e8a0b6106d270d442f161">00080</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#ad889e68ac21e8a0b6106d270d442f161">$updateInterval</a>          = 432000; <span class="comment">// 5 days</span>
<a name="l00081"></a><a class="code" href="class_browscap.html#a362f511a508b0351d628cb26fe547858">00081</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a362f511a508b0351d628cb26fe547858">$errorInterval</a>           = 7200;           <span class="comment">// 2 hours</span>
<a name="l00082"></a><a class="code" href="class_browscap.html#ab71f1dd8358d35e9650a060d905ff11c">00082</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#ab71f1dd8358d35e9650a060d905ff11c">$doAutoUpdate</a>            = <span class="keyword">true</span>;
<a name="l00083"></a><a class="code" href="class_browscap.html#a5a07c9446a0ff9192624d219c5b86ecb">00083</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a5a07c9446a0ff9192624d219c5b86ecb">$updateMethod</a>            = null;
<a name="l00084"></a>00084 
<a name="l00091"></a><a class="code" href="class_browscap.html#adc6cc2df0b8f3fade79188962069aeca">00091</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#adc6cc2df0b8f3fade79188962069aeca">$localFile</a>                               = null;
<a name="l00092"></a>00092 
<a name="l00099"></a><a class="code" href="class_browscap.html#af72885788822104b509d92e7c4c17eb7">00099</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#af72885788822104b509d92e7c4c17eb7">$userAgent</a>                               = <span class="stringliteral">&#39;Browser Capabilities Project - PHP Browscap/%v %m&#39;</span>;
<a name="l00100"></a>00100 
<a name="l00107"></a><a class="code" href="class_browscap.html#a6b47f5a0dd13c7e9d6568dcd154dffc5">00107</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a6b47f5a0dd13c7e9d6568dcd154dffc5">$lowercase</a>                               = <span class="keyword">false</span>;
<a name="l00108"></a>00108 
<a name="l00117"></a><a class="code" href="class_browscap.html#a3e45c8f244257ce1bc20d6b83cae61b5">00117</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a3e45c8f244257ce1bc20d6b83cae61b5">$silent</a>                                  = <span class="keyword">false</span>;
<a name="l00118"></a>00118 
<a name="l00124"></a><a class="code" href="class_browscap.html#af3ab3137007f6fa0a24b542d15ed0ed2">00124</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#af3ab3137007f6fa0a24b542d15ed0ed2">$cacheFilename</a>           = <span class="stringliteral">&#39;cache.php&#39;</span>;
<a name="l00125"></a>00125 
<a name="l00131"></a><a class="code" href="class_browscap.html#ad06085c6441edc519abfaa5a9927622a">00131</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#ad06085c6441edc519abfaa5a9927622a">$iniFilename</a>                             = <span class="stringliteral">&#39;browscap.ini&#39;</span>;
<a name="l00132"></a>00132 
<a name="l00138"></a><a class="code" href="class_browscap.html#a1be776a7b96d8c01a6bf45ce20a8f59a">00138</a>                 <span class="keyword">public</span> <a class="code" href="class_browscap.html#a1be776a7b96d8c01a6bf45ce20a8f59a">$cacheDir</a>                                = null;
<a name="l00139"></a>00139 
<a name="l00145"></a><a class="code" href="class_browscap.html#abf6d24dd7988f82e8573305994bcfd3e">00145</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#abf6d24dd7988f82e8573305994bcfd3e">$_cacheLoaded</a>           = <span class="keyword">false</span>;
<a name="l00146"></a>00146 
<a name="l00152"></a><a class="code" href="class_browscap.html#afc001998d0530df9f8fbd2a807768c31">00152</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#afc001998d0530df9f8fbd2a807768c31">$_userAgents</a>            = array();
<a name="l00153"></a><a class="code" href="class_browscap.html#ac3b2e2a065585665ccf59d4241c076e2">00153</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#ac3b2e2a065585665ccf59d4241c076e2">$_browsers</a>                              = array();
<a name="l00154"></a><a class="code" href="class_browscap.html#a75cee4529db44cfe300c96c76840afc3">00154</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#a75cee4529db44cfe300c96c76840afc3">$_patterns</a>                              = array();
<a name="l00155"></a><a class="code" href="class_browscap.html#a7685974adf550455a5cfe604ba0e16bf">00155</a>                 <span class="keyword">private</span> <a class="code" href="class_browscap.html#a7685974adf550455a5cfe604ba0e16bf">$_properties</a>            = array();
<a name="l00156"></a>00156 
<a name="l00163"></a><a class="code" href="class_browscap.html#a3811d4c7cf568446f8cdf6b407e12d71">00163</a>                 <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a3811d4c7cf568446f8cdf6b407e12d71">__construct</a>($cache_dir)
<a name="l00164"></a>00164                 {
<a name="l00165"></a>00165                                 <span class="comment">// has to be set to reach E_STRICT compatibility, does not affect system/app settings</span>
<a name="l00166"></a>00166                                 date_default_timezone_set(date_default_timezone_get());
<a name="l00167"></a>00167 
<a name="l00168"></a>00168                                 <span class="keywordflow">if</span> (!isset($cache_dir)) {
<a name="l00169"></a>00169                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;You have to provide a path to read/store the browscap cache file&quot;</span>, 2034);
<a name="l00170"></a>00170                                 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172                                 $cache_dir = realpath($cache_dir);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174                                 <span class="comment">// Is the cache dir really the directory or is it directly the file?</span>
<a name="l00175"></a>00175                                 <span class="keywordflow">if</span> (substr($cache_dir, -4) === <span class="stringliteral">&#39;.php&#39;</span>) {
<a name="l00176"></a>00176                                                 $this-&gt;cacheFilename = basename($cache_dir);
<a name="l00177"></a>00177                                                 $this-&gt;cacheDir = dirname($cache_dir);
<a name="l00178"></a>00178                                 } <span class="keywordflow">else</span> {
<a name="l00179"></a>00179                                                 $this-&gt;cacheDir = $cache_dir;
<a name="l00180"></a>00180                                 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182                                 $this-&gt;cacheDir .= DIRECTORY_SEPARATOR;
<a name="l00183"></a>00183                 }
<a name="l00184"></a>00184 
<a name="l00194"></a><a class="code" href="class_browscap.html#aeac9cab5428d846a64100b9768f2ce3d">00194</a>                 <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#aeac9cab5428d846a64100b9768f2ce3d">getBrowser</a>($user_agent = null, $return_array = <span class="keyword">false</span>)
<a name="l00195"></a>00195                 {
<a name="l00196"></a>00196                                 <span class="comment">// Load the cache at the first request</span>
<a name="l00197"></a>00197                                 <span class="keywordflow">if</span> (!$this-&gt;_cacheLoaded) {
<a name="l00198"></a>00198                                                 $cache_file = $this-&gt;cacheDir . $this-&gt;cacheFilename;
<a name="l00199"></a>00199                                                 $ini_file       = $this-&gt;cacheDir . $this-&gt;iniFilename;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                                                 <span class="comment">// Set the interval only if needed</span>
<a name="l00202"></a>00202                                                 <span class="keywordflow">if</span> ($this-&gt;doAutoUpdate &amp;&amp; file_exists($ini_file)) {
<a name="l00203"></a>00203                                                                 $interval = time() - filemtime($ini_file);
<a name="l00204"></a>00204                                                 } <span class="keywordflow">else</span> {
<a name="l00205"></a>00205                                                                 $interval = 0;
<a name="l00206"></a>00206                                                 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208                                                 <span class="comment">// Find out if the cache needs to be updated</span>
<a name="l00209"></a>00209                                                 <span class="keywordflow">if</span> (!file_exists($cache_file) || !file_exists($ini_file) || ($interval &gt; $this-&gt;updateInterval)) {
<a name="l00210"></a>00210                                                                 <span class="keywordflow">try</span> {
<a name="l00211"></a>00211                                                                                 $this-&gt;<a class="code" href="class_browscap.html#acc4b8a4876aa93bd8e94add85e112a04">updateCache</a>();
<a name="l00212"></a>00212                                                                 } <span class="keywordflow">catch</span> (RuntimeException $e) {
<a name="l00213"></a>00213                                                                                 <span class="keywordflow">if</span> (file_exists($ini_file)) {
<a name="l00214"></a>00214                                                                                                 <span class="comment">// Adjust the filemtime to the $errorInterval</span>
<a name="l00215"></a>00215                                                                                                 touch($ini_file, time() - $this-&gt;updateInterval + $this-&gt;errorInterval);
<a name="l00216"></a>00216                                                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($this-&gt;silent) {
<a name="l00217"></a>00217                                                                                                 <span class="comment">// Return an array if silent mode is active and the ini db doesn&#39;t exsist</span>
<a name="l00218"></a>00218                                                                                                 <span class="keywordflow">return</span> array();
<a name="l00219"></a>00219                                                                                 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                                                                                 <span class="keywordflow">if</span> (!$this-&gt;silent) {
<a name="l00222"></a>00222                                                                                     <span class="keywordflow">if</span> (PHP_VERSION_ID &gt;= 50300)
<a name="l00223"></a>00223                                                                                                     <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Update cache failed&quot;</span>, 2035, $e);
<a name="l00224"></a>00224                                                                         <span class="keywordflow">else</span>
<a name="l00225"></a>00225                                                                             <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Update cache failed&quot;</span>, 2035);
<a name="l00226"></a>00226                                                                                 }
<a name="l00227"></a>00227                                                                 }
<a name="l00228"></a>00228                                                 }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230                                                 $this-&gt;<a class="code" href="class_browscap.html#abf1cd07f603daa567f53228744f75bad">_loadCache</a>($cache_file);
<a name="l00231"></a>00231                                 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233                                 <span class="comment">// Automatically detect the useragent</span>
<a name="l00234"></a>00234                                 <span class="keywordflow">if</span> (!isset($user_agent)) {
<a name="l00235"></a>00235                                                 <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>])) {
<a name="l00236"></a>00236                                                                 $user_agent = $_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>];
<a name="l00237"></a>00237                                                 } <span class="keywordflow">else</span> {
<a name="l00238"></a>00238                                                                 $user_agent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00239"></a>00239                                                 }
<a name="l00240"></a>00240                                 }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242                                 $browser = array();
<a name="l00243"></a>00243                                 <span class="keywordflow">foreach</span> ($this-&gt;_patterns as $key =&gt; $pattern) {
<a name="l00244"></a>00244                                                 <span class="keywordflow">if</span> (preg_match($pattern . <span class="charliteral">&#39;i&#39;</span>, $user_agent)) {
<a name="l00245"></a>00245                                                                 $browser = array(
<a name="l00246"></a>00246                                                                                 $user_agent, <span class="comment">// Original useragent</span>
<a name="l00247"></a>00247                                                                                 trim(strtolower($pattern), self::REGEX_DELIMITER),
<a name="l00248"></a>00248                                                                                 $this-&gt;_userAgents[$key]
<a name="l00249"></a>00249                                                                 );
<a name="l00250"></a>00250 
<a name="l00251"></a>00251                                                                 $browser = $value = $browser + $this-&gt;_browsers[$key];
<a name="l00252"></a>00252 
<a name="l00253"></a>00253                                                                 <span class="keywordflow">while</span> (array_key_exists(3, $value) &amp;&amp; $value[3]) {
<a name="l00254"></a>00254                                                                                 $value                          =               $this-&gt;_browsers[$value[3]];
<a name="l00255"></a>00255                                                                                 $browser        +=              $value;
<a name="l00256"></a>00256                                                                 }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258                                                                 <span class="keywordflow">if</span> (!empty($browser[3])) {
<a name="l00259"></a>00259                                                                                 $browser[3] = $this-&gt;_userAgents[$browser[3]];
<a name="l00260"></a>00260                                                                 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262                                                                 <span class="keywordflow">break</span>;
<a name="l00263"></a>00263                                                 }
<a name="l00264"></a>00264                                 }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266                                 <span class="comment">// Add the keys for each property</span>
<a name="l00267"></a>00267                                 $array = array();
<a name="l00268"></a>00268                                 <span class="keywordflow">foreach</span> ($browser as $key =&gt; $value) {
<a name="l00269"></a>00269       <span class="keywordflow">if</span> ($value === <span class="stringliteral">&#39;true&#39;</span>) {
<a name="l00270"></a>00270         $value = <span class="keyword">true</span>;
<a name="l00271"></a>00271       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($value === <span class="stringliteral">&#39;false&#39;</span>) {
<a name="l00272"></a>00272         $value = <span class="keyword">false</span>;
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275                                                 $array[$this-&gt;_properties[$key]] = $value;
<a name="l00276"></a>00276                                 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278                                 <span class="keywordflow">return</span> $return_array ? $array : (object) $array;
<a name="l00279"></a>00279                 }
<a name="l00280"></a>00280 
<a name="l00286"></a><a class="code" href="class_browscap.html#acc4b8a4876aa93bd8e94add85e112a04">00286</a>                 <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#acc4b8a4876aa93bd8e94add85e112a04">updateCache</a>()
<a name="l00287"></a>00287                 {
<a name="l00288"></a>00288                                 $ini_path                                       = $this-&gt;cacheDir . $this-&gt;iniFilename;
<a name="l00289"></a>00289                                 $cache_path                                     = $this-&gt;cacheDir . $this-&gt;cacheFilename;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291                                 <span class="comment">// Choose the right url</span>
<a name="l00292"></a>00292                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>() == self::UPDATE_LOCAL) {
<a name="l00293"></a>00293                                                 $url = $this-&gt;localFile;
<a name="l00294"></a>00294                                 } <span class="keywordflow">else</span> {
<a name="l00295"></a>00295                                                 $url = $this-&gt;remoteIniUrl;
<a name="l00296"></a>00296                                 }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                                 $this-&gt;<a class="code" href="class_browscap.html#a7f6b082f1c3b4dfd5ab839b057fc67d7">_getRemoteIniFile</a>($url, $ini_path);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300                                 <span class="keywordflow">if</span> (version_compare(PHP_VERSION, <span class="stringliteral">&#39;5.3.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>)){
<a name="l00301"></a>00301                                                 $browsers = parse_ini_file($ini_path, <span class="keyword">true</span>, INI_SCANNER_RAW);
<a name="l00302"></a>00302                                 } <span class="keywordflow">else</span> {
<a name="l00303"></a>00303                                                 $browsers = parse_ini_file($ini_path, <span class="keyword">true</span>);
<a name="l00304"></a>00304                                 }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306                                 array_shift($browsers);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308                                 $this-&gt;_properties              = array_keys($browsers[<span class="stringliteral">&#39;DefaultProperties&#39;</span>]);
<a name="l00309"></a>00309                                 array_unshift(
<a name="l00310"></a>00310                                                 $this-&gt;_properties,
<a name="l00311"></a>00311                                                 <span class="stringliteral">&#39;browser_name&#39;</span>,
<a name="l00312"></a>00312                                                 <span class="stringliteral">&#39;browser_name_regex&#39;</span>,
<a name="l00313"></a>00313                                                 <span class="stringliteral">&#39;browser_name_pattern&#39;</span>,
<a name="l00314"></a>00314                                                 <span class="stringliteral">&#39;Parent&#39;</span>
<a name="l00315"></a>00315                                 );
<a name="l00316"></a>00316 
<a name="l00317"></a>00317                                 $this-&gt;_userAgents              = array_keys($browsers);
<a name="l00318"></a>00318                                 usort(
<a name="l00319"></a>00319                                                 $this-&gt;_userAgents,
<a name="l00320"></a>00320                                                 create_function(self::ORDER_FUNC_ARGS, self::ORDER_FUNC_LOGIC)
<a name="l00321"></a>00321                                 );
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                                 $user_agents_keys               = array_flip($this-&gt;_userAgents);
<a name="l00324"></a>00324                                 $properties_keys                = array_flip($this-&gt;_properties);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326                                 $search                                                         = array(<span class="charliteral">&#39;\*&#39;</span>, <span class="charliteral">&#39;\?&#39;</span>);
<a name="l00327"></a>00327                                 $replace                                        = array(<span class="stringliteral">&#39;.*&#39;</span>, <span class="charliteral">&#39;.&#39;</span>);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                                 <span class="keywordflow">foreach</span> ($this-&gt;_userAgents as $user_agent) {
<a name="l00330"></a>00330                                                 $pattern = preg_quote($user_agent, self::REGEX_DELIMITER);
<a name="l00331"></a>00331                                                 $this-&gt;_patterns[]              = self::REGEX_DELIMITER
<a name="l00332"></a>00332                                                                                                                                 . <span class="charliteral">&#39;^&#39;</span>
<a name="l00333"></a>00333                                                                                                                                 . str_replace($search, $replace, $pattern)
<a name="l00334"></a>00334                                                                                                                                 . <span class="charliteral">&#39;$&#39;</span>
<a name="l00335"></a>00335                                                                                                                                 . <a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">self::REGEX_DELIMITER</a>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337                                                 <span class="keywordflow">if</span> (!empty($browsers[$user_agent][<span class="stringliteral">&#39;Parent&#39;</span>])) {
<a name="l00338"></a>00338                                                                 $parent = $browsers[$user_agent][<span class="stringliteral">&#39;Parent&#39;</span>];
<a name="l00339"></a>00339                                                                 $browsers[$user_agent][<span class="stringliteral">&#39;Parent&#39;</span>] = $user_agents_keys[$parent];
<a name="l00340"></a>00340                                                 }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342                                                 <span class="keywordflow">foreach</span> ($browsers[$user_agent] as $key =&gt; $value) {
<a name="l00343"></a>00343                                                                 $key = $properties_keys[$key] . <span class="stringliteral">&quot;.0&quot;</span>;
<a name="l00344"></a>00344                                                                 $browser[$key] = $value;
<a name="l00345"></a>00345                                                 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347                                                 $this-&gt;_browsers[] = $browser;
<a name="l00348"></a>00348                                                 unset($browser);
<a name="l00349"></a>00349                                 }
<a name="l00350"></a>00350                                 unset($user_agents_keys, $properties_keys, $browsers);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352                                 <span class="comment">// Save the keys lowercased if needed</span>
<a name="l00353"></a>00353                                 <span class="keywordflow">if</span> ($this-&gt;lowercase) {
<a name="l00354"></a>00354                                                 $this-&gt;_properties = array_map(<span class="stringliteral">&#39;strtolower&#39;</span>, $this-&gt;_properties);
<a name="l00355"></a>00355                                 }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357                                 <span class="comment">// Get the whole PHP code</span>
<a name="l00358"></a>00358                                 $cache = $this-&gt;<a class="code" href="class_browscap.html#a33a0ff1a7b7574296837bdae9c538d27">_buildCache</a>();
<a name="l00359"></a>00359 
<a name="l00360"></a>00360                                 <span class="comment">// Save and return</span>
<a name="l00361"></a>00361                                 <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>) file_put_contents($cache_path, $cache, LOCK_EX);
<a name="l00362"></a>00362                 }
<a name="l00363"></a>00363 
<a name="l00369"></a><a class="code" href="class_browscap.html#abf1cd07f603daa567f53228744f75bad">00369</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#abf1cd07f603daa567f53228744f75bad">_loadCache</a>($cache_file)
<a name="l00370"></a>00370                 {
<a name="l00371"></a>00371                                 require $cache_file;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373                                 $this-&gt;_browsers                = $browsers;
<a name="l00374"></a>00374                                 $this-&gt;_userAgents              = $userAgents;
<a name="l00375"></a>00375                                 $this-&gt;_patterns                = $patterns;
<a name="l00376"></a>00376                                 $this-&gt;_properties              = $properties;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378                                 $this-&gt;_cacheLoaded = <span class="keyword">true</span>;
<a name="l00379"></a>00379                 }
<a name="l00380"></a>00380 
<a name="l00386"></a><a class="code" href="class_browscap.html#a33a0ff1a7b7574296837bdae9c538d27">00386</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a33a0ff1a7b7574296837bdae9c538d27">_buildCache</a>()
<a name="l00387"></a>00387                 {
<a name="l00388"></a>00388                                 $cacheTpl = <span class="stringliteral">&quot;&lt;?php\n\$properties=%s;\n\$browsers=%s;\n\$userAgents=%s;\n\$patterns=%s;\n&quot;</span>;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390                                 $propertiesArray                = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_properties);
<a name="l00391"></a>00391                                 $patternsArray                  = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_patterns);
<a name="l00392"></a>00392                                 $userAgentsArray                = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_userAgents);
<a name="l00393"></a>00393                                 $browsersArray                  = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($this-&gt;_browsers);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                                 <span class="keywordflow">return</span> sprintf(
<a name="l00396"></a>00396                                                 $cacheTpl,
<a name="l00397"></a>00397                                                 $propertiesArray,
<a name="l00398"></a>00398                                                 $browsersArray,
<a name="l00399"></a>00399                                                 $userAgentsArray,
<a name="l00400"></a>00400                                                 $patternsArray
<a name="l00401"></a>00401                                 );
<a name="l00402"></a>00402                 }
<a name="l00403"></a>00403 
<a name="l00413"></a><a class="code" href="class_browscap.html#a7f6b082f1c3b4dfd5ab839b057fc67d7">00413</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a7f6b082f1c3b4dfd5ab839b057fc67d7">_getRemoteIniFile</a>($url, $path)
<a name="l00414"></a>00414                 {
<a name="l00415"></a>00415                                 <span class="comment">// Check version</span>
<a name="l00416"></a>00416                                 <span class="keywordflow">if</span> (file_exists($path) &amp;&amp; filesize($path)) {
<a name="l00417"></a>00417                                                 $local_tmstp    = filemtime($path);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419                                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>() == self::UPDATE_LOCAL) {
<a name="l00420"></a>00420                                                                 $remote_tmstp = $this-&gt;<a class="code" href="class_browscap.html#ae2b8c55e462e837907483240c4f785fe">_getLocalMTime</a>();
<a name="l00421"></a>00421                                                 } <span class="keywordflow">else</span> {
<a name="l00422"></a>00422                                                                 $remote_tmstp = $this-&gt;<a class="code" href="class_browscap.html#ad362b45734467dab2fecb3f0d56a1589">_getRemoteMTime</a>();
<a name="l00423"></a>00423                                                 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425                                                 <span class="keywordflow">if</span> ($remote_tmstp &lt; $local_tmstp) {
<a name="l00426"></a>00426                                                                 <span class="comment">// No update needed, return</span>
<a name="l00427"></a>00427                                                                 touch($path);
<a name="l00428"></a>00428                                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00429"></a>00429                                                 }
<a name="l00430"></a>00430                                 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432                                 <span class="comment">// Get updated .ini file</span>
<a name="l00433"></a>00433                                 $browscap = $this-&gt;<a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">_getRemoteData</a>($url);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 
<a name="l00436"></a>00436                                 $browscap = explode(<span class="stringliteral">&quot;\n&quot;</span>, $browscap);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438                                 $pattern = self::REGEX_DELIMITER
<a name="l00439"></a>00439                                                                  . <span class="charliteral">&#39;(&#39;</span>
<a name="l00440"></a>00440                                                                  . self::VALUES_TO_QUOTE
<a name="l00441"></a>00441                                                                  . <span class="stringliteral">&#39;)=&quot;?([^&quot;]*)&quot;?$&#39;</span>
<a name="l00442"></a>00442                                                                  . <a class="code" href="class_browscap.html#a8ab9b8a5fa59b05372830b617cfd464b">self::REGEX_DELIMITER</a>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a>00445                                 <span class="comment">// Ok, lets read the file</span>
<a name="l00446"></a>00446                                 $content = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00447"></a>00447                                 <span class="keywordflow">foreach</span> ($browscap as $subject) {
<a name="l00448"></a>00448                                                 $subject = trim($subject);
<a name="l00449"></a>00449                                                 $content .= preg_replace($pattern, <span class="stringliteral">&#39;$1=&quot;$2&quot;&#39;</span>, $subject) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00450"></a>00450                                 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452                                 <span class="keywordflow">if</span> (!file_put_contents($path, $content)) {
<a name="l00453"></a>00453                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Could not write .ini content to $path&quot;</span>, 2036);
<a name="l00454"></a>00454                                 }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00457"></a>00457                 }
<a name="l00458"></a>00458 
<a name="l00465"></a><a class="code" href="class_browscap.html#ad362b45734467dab2fecb3f0d56a1589">00465</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#ad362b45734467dab2fecb3f0d56a1589">_getRemoteMTime</a>()
<a name="l00466"></a>00466                 {
<a name="l00467"></a>00467                                 $remote_datetime = $this-&gt;<a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">_getRemoteData</a>($this-&gt;remoteVerUrl);
<a name="l00468"></a>00468                                 $remote_tmstp = strtotime($remote_datetime);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470                                 <span class="keywordflow">if</span> (!$remote_tmstp) {
<a name="l00471"></a>00471                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Bad datetime format from {$this-&gt;remoteVerUrl}&quot;</span>, 2037);
<a name="l00472"></a>00472                                 }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474                                 <span class="keywordflow">return</span> $remote_tmstp;
<a name="l00475"></a>00475                 }
<a name="l00476"></a>00476 
<a name="l00483"></a><a class="code" href="class_browscap.html#ae2b8c55e462e837907483240c4f785fe">00483</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#ae2b8c55e462e837907483240c4f785fe">_getLocalMTime</a>()
<a name="l00484"></a>00484                 {
<a name="l00485"></a>00485                                 <span class="keywordflow">if</span> (!is_readable($this-&gt;localFile) || !is_file($this-&gt;localFile)) {
<a name="l00486"></a>00486                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Local file is not readable&quot;</span>, 2038);
<a name="l00487"></a>00487                                 }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489                                 <span class="keywordflow">return</span> filemtime($this-&gt;localFile);
<a name="l00490"></a>00490                 }
<a name="l00491"></a>00491 
<a name="l00501"></a><a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">00501</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($array)
<a name="l00502"></a>00502                 {
<a name="l00503"></a>00503                                 $strings = array();
<a name="l00504"></a>00504 
<a name="l00505"></a>00505                                 <span class="keywordflow">foreach</span> ($array as $key =&gt; $value) {
<a name="l00506"></a>00506                                                 <span class="keywordflow">if</span> (is_int($key)) {
<a name="l00507"></a>00507                                                                 $key            = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00508"></a>00508                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctype_digit((<span class="keywordtype">string</span>) $key) || strpos($key, <span class="stringliteral">&#39;.0&#39;</span>)) {
<a name="l00509"></a>00509                                                                 $key            = intval($key) . <span class="stringliteral">&#39;=&gt;&#39;</span> ;
<a name="l00510"></a>00510                                                 } <span class="keywordflow">else</span> {
<a name="l00511"></a>00511                                                                 $key            = <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;\&#39;&quot;</span>, $key) . <span class="stringliteral">&quot;&#39;=&gt;&quot;</span> ;
<a name="l00512"></a>00512                                                 }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514                                                 <span class="keywordflow">if</span> (is_array($value)) {
<a name="l00515"></a>00515                                                                 $value          = $this-&gt;<a class="code" href="class_browscap.html#af90d03713a5e3773dff3a5777743736a">_array2string</a>($value);
<a name="l00516"></a>00516                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctype_digit((<span class="keywordtype">string</span>) $value)) {
<a name="l00517"></a>00517                                                                 $value          = intval($value);
<a name="l00518"></a>00518                                                 } <span class="keywordflow">else</span> {
<a name="l00519"></a>00519                                                                 $value          = <span class="stringliteral">&quot;&#39;&quot;</span> . str_replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;\&#39;&quot;</span>, $value) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00520"></a>00520                                                 }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522                                                 $strings[]      = $key . $value;
<a name="l00523"></a>00523                                 }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525                                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;array(&#39;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, $strings) . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00526"></a>00526                 }
<a name="l00527"></a>00527 
<a name="l00534"></a><a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">00534</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>()
<a name="l00535"></a>00535                 {
<a name="l00536"></a>00536                                 <span class="comment">// Caches the result</span>
<a name="l00537"></a>00537                                 <span class="keywordflow">if</span> ($this-&gt;updateMethod === null) {
<a name="l00538"></a>00538                                                 <span class="keywordflow">if</span> ($this-&gt;localFile !== null) {
<a name="l00539"></a>00539                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#aa1818d249b2738caef5a427ae46e7192">self::UPDATE_LOCAL</a>;
<a name="l00540"></a>00540                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;allow_url_fopen&#39;</span>) &amp;&amp; function_exists(<span class="stringliteral">&#39;file_get_contents&#39;</span>)) {
<a name="l00541"></a>00541                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#a4bb06801c0ec7614991e8f27e795827d">self::UPDATE_FOPEN</a>;
<a name="l00542"></a>00542                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;fsockopen&#39;</span>)) {
<a name="l00543"></a>00543                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#a116f54fc3b0f6572933f9275165ece98">self::UPDATE_FSOCKOPEN</a>;
<a name="l00544"></a>00544                                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (extension_loaded(<span class="stringliteral">&#39;curl&#39;</span>)) {
<a name="l00545"></a>00545                                                                 $this-&gt;updateMethod = <a class="code" href="class_browscap.html#a5ccad9a4e74911b586c59b2903f6a397">self::UPDATE_CURL</a>;
<a name="l00546"></a>00546                                                 } <span class="keywordflow">else</span> {
<a name="l00547"></a>00547                                                                 $this-&gt;updateMethod = <span class="keyword">false</span>;
<a name="l00548"></a>00548                                                 }
<a name="l00549"></a>00549                                 }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551                                 <span class="keywordflow">return</span> $this-&gt;updateMethod;
<a name="l00552"></a>00552                 }
<a name="l00553"></a>00553 
<a name="l00561"></a><a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">00561</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#a8bdee774894a9d34e3a95d4e999840f8">_getRemoteData</a>($url)
<a name="l00562"></a>00562                 {
<a name="l00563"></a>00563                                 ini_set(<span class="stringliteral">&#39;user_agent&#39;</span>, $this-&gt;<a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>());
<a name="l00564"></a>00564                                 
<a name="l00565"></a>00565                                 <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>()) {
<a name="l00566"></a>00566                                                 <span class="keywordflow">case</span> self::UPDATE_LOCAL:
<a name="l00567"></a>00567                                                                 $file = file_get_contents($url);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569                                                                 <span class="keywordflow">if</span> ($file !== <span class="keyword">false</span>) {
<a name="l00570"></a>00570                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00571"></a>00571                                                                 } <span class="keywordflow">else</span> {
<a name="l00572"></a>00572                                                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&#39;Cannot open the local file&#39;</span>, 2039);
<a name="l00573"></a>00573                                                                 }
<a name="l00574"></a>00574                                                 <span class="keywordflow">case</span> self::UPDATE_FOPEN:
<a name="l00575"></a>00575                                                                 $file = file_get_contents($url);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577                                                                 <span class="keywordflow">if</span> ($file !== <span class="keyword">false</span>) {
<a name="l00578"></a>00578                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00579"></a>00579                                                                 } <span class="comment">// else try with the next possibility (break omitted)</span>
<a name="l00580"></a>00580                                                 <span class="keywordflow">case</span> self::UPDATE_FSOCKOPEN:
<a name="l00581"></a>00581                                                                 $remote_url                     = parse_url($url);
<a name="l00582"></a>00582                                                                 $remote_handler = fsockopen($remote_url[<span class="stringliteral">&#39;host&#39;</span>], 80, $c, $e, $this-&gt;timeout);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                                                                 <span class="keywordflow">if</span> ($remote_handler) {
<a name="l00585"></a>00585                                                                                 stream_set_timeout($remote_handler, $this-&gt;timeout);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587                                                                                 <span class="keywordflow">if</span> (isset($remote_url[<span class="stringliteral">&#39;query&#39;</span>])) {
<a name="l00588"></a>00588                                                                                                 $remote_url[<span class="stringliteral">&#39;path&#39;</span>] .= <span class="charliteral">&#39;?&#39;</span> . $remote_url[<span class="stringliteral">&#39;query&#39;</span>];
<a name="l00589"></a>00589                                                                                 }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591                                                                                 $out = sprintf(
<a name="l00592"></a>00592                                                                                                 self::REQUEST_HEADERS,
<a name="l00593"></a>00593                                                                                                 $remote_url[<span class="stringliteral">&#39;path&#39;</span>],
<a name="l00594"></a>00594                                                                                                 $remote_url[<span class="stringliteral">&#39;host&#39;</span>],
<a name="l00595"></a>00595                                                                                                 $this-&gt;<a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>()
<a name="l00596"></a>00596                                                                                 );
<a name="l00597"></a>00597 
<a name="l00598"></a>00598                                                                                 fwrite($remote_handler, $out);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600                                                                                 $response = fgets($remote_handler);
<a name="l00601"></a>00601                                                                                 <span class="keywordflow">if</span> (strpos($response, <span class="stringliteral">&#39;200 OK&#39;</span>) !== <span class="keyword">false</span>) {
<a name="l00602"></a>00602                                                                                                 $file = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00603"></a>00603                                                                                                 <span class="keywordflow">while</span> (!feof($remote_handler)) {
<a name="l00604"></a>00604                                                                                                                 $file .= fgets($remote_handler);
<a name="l00605"></a>00605                                                                                                 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607                                                                                                 $file = str_replace(<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $file);
<a name="l00608"></a>00608                                                                                                 $file = explode(<span class="stringliteral">&quot;\n\n&quot;</span>, $file);
<a name="l00609"></a>00609                                                                                                 array_shift($file);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611                                                                                                 $file = implode(<span class="stringliteral">&quot;\n\n&quot;</span>, $file);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613                                                                                                 fclose($remote_handler);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00616"></a>00616                                                                                 }
<a name="l00617"></a>00617                                                                 } <span class="comment">// else try with the next possibility</span>
<a name="l00618"></a>00618                                                 <span class="keywordflow">case</span> self::UPDATE_CURL:
<a name="l00619"></a>00619                                                                 $ch = curl_init($url);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621                                                                 curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);
<a name="l00622"></a>00622                                                                 curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $this-&gt;timeout);
<a name="l00623"></a>00623                                                                 curl_setopt($ch, CURLOPT_USERAGENT, $this-&gt;<a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>());
<a name="l00624"></a>00624 
<a name="l00625"></a>00625                                                                 $file = curl_exec($ch);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627                                                                 curl_close($ch);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629                                                                 <span class="keywordflow">if</span> ($file !== <span class="keyword">false</span>) {
<a name="l00630"></a>00630                                                                                 <span class="keywordflow">return</span> $file;
<a name="l00631"></a>00631                                                                 } <span class="comment">// else try with the next possibility</span>
<a name="l00632"></a>00632                                                 <span class="keywordflow">case</span> <span class="keyword">false</span>:
<a name="l00633"></a>00633                                                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RuntimeException(<span class="stringliteral">&quot;Your server can&#39;t connect to external resources. Please update the file manually.&quot;</span>, 2033);
<a name="l00634"></a>00634                                 }
<a name="l00635"></a>00635                 }
<a name="l00636"></a>00636 
<a name="l00643"></a><a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">00643</a>                 <span class="keyword">private</span> <span class="keyword">function</span> <a class="code" href="class_browscap.html#abe6df298cd4b0fc91c6eeb25c7d98cd6">_getUserAgent</a>()
<a name="l00644"></a>00644                 {
<a name="l00645"></a>00645                                 $ua = str_replace(<span class="stringliteral">&#39;%v&#39;</span>, self::VERSION, $this-&gt;userAgent);
<a name="l00646"></a>00646                                 $ua = str_replace(<span class="stringliteral">&#39;%m&#39;</span>, $this-&gt;<a class="code" href="class_browscap.html#abdb6ab3847ab49bdfb0c385e7dea611d">_getUpdateMethod</a>(), $ua);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648                                 <span class="keywordflow">return</span> $ua;
<a name="l00649"></a>00649                 }
<a name="l00650"></a>00650 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_browscap_8class_8php.html">Browscap.class.php</a>      </li>

    <li class="footer">Generated on Tue Feb 28 2012 14:08:34 for Axiom by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
